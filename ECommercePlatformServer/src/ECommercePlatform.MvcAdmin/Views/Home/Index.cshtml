@model ECommercePlatform.MvcAdmin.DTOs.Dashboard.DashboardStatsDto
@using ECommercePlatform.MvcAdmin.DTOs.Orders

@{
    ViewData["Title"] = "Dashboard";
    var apiBaseUrl = ViewBag.ApiBaseUrl as string ?? "";
}

<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
    <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle mb-0">Hoş geldiniz, @ViewBag.UserName! İşte bugünkü özet.</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary" style="border-radius: 10px;" onclick="location.reload()">
            <i class="fas fa-sync-alt me-2"></i>Yenile
        </button>
        <a asp-controller="Product" asp-action="Create" class="btn btn-primary-gradient">
            <i class="fas fa-plus me-2"></i>Yeni Ürün
        </a>
    </div>
</div>

<!-- Ana İstatistik Kartları -->
<div class="row g-4 mb-4">
    <!-- Toplam Sipariş -->
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="stat-icon primary">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    @if (Model.PendingOrders > 0)
                    {
                        <span class="badge bg-warning text-dark" style="border-radius: 8px;">
                            <i class="fas fa-clock me-1"></i>@Model.PendingOrders bekleyen
                        </span>
                    }
                </div>
                <div class="stat-value">@Model.TotalOrders.ToString("N0")</div>
                <div class="stat-label">Toplam Sipariş</div>
                <div class="mt-2">
                    <a asp-controller="Order" asp-action="Index" class="text-primary small text-decoration-none">
                        Siparişleri Gör <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toplam Gelir -->
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="stat-icon success">
                        <i class="fas fa-lira-sign"></i>
                    </div>
                    @if (Model.DeliveredOrders > 0)
                    {
                        <span class="badge bg-success" style="border-radius: 8px;">
                            <i class="fas fa-check me-1"></i>@Model.DeliveredOrders teslim
                        </span>
                    }
                </div>
                <div class="stat-value">₺@Model.TotalRevenue.ToString("N0")</div>
                <div class="stat-label">Toplam Gelir</div>
                <div class="mt-2 text-muted small">
                    <i class="fas fa-info-circle me-1"></i>Teslim edilen siparişlerden
                </div>
            </div>
        </div>
    </div>

    <!-- Toplam Ürün -->
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="stat-icon warning">
                        <i class="fas fa-box"></i>
                    </div>
                    @if (Model.OutOfStockProducts > 0)
                    {
                        <span class="badge bg-danger" style="border-radius: 8px;">
                            <i class="fas fa-exclamation me-1"></i>@Model.OutOfStockProducts tükenen
                        </span>
                    }
                    else if (Model.LowStockProducts > 0)
                    {
                        <span class="badge bg-warning text-dark" style="border-radius: 8px;">
                            <i class="fas fa-exclamation me-1"></i>@Model.LowStockProducts düşük
                        </span>
                    }
                </div>
                <div class="stat-value">@Model.TotalProducts.ToString("N0")</div>
                <div class="stat-label">Toplam Ürün</div>
                <div class="mt-2">
                    <a asp-controller="Product" asp-action="Index" class="text-primary small text-decoration-none">
                        Ürünleri Gör <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toplam Müşteri -->
    <div class="col-sm-6 col-xl-3">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="stat-icon danger">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="stat-value">@Model.TotalCustomers.ToString("N0")</div>
                <div class="stat-label">Toplam Müşteri</div>
                <div class="mt-2">
                    <a asp-controller="Customer" asp-action="Index" class="text-primary small text-decoration-none">
                        Müşterileri Gör <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İkinci Satır - Detay İstatistikler -->
<div class="row g-4 mb-4">
    <!-- Sipariş Durumları -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2 text-primary"></i>Sipariş Durumları
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(245, 158, 11, 0.1);">
                            <div class="fs-4 fw-bold text-warning">@Model.PendingOrders</div>
                            <small class="text-muted">Beklemede</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(59, 130, 246, 0.1);">
                            <div class="fs-4 fw-bold text-info">@Model.ConfirmedOrders</div>
                            <small class="text-muted">Onaylanan</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(245, 158, 11, 0.1);">
                            <div class="fs-4 fw-bold text-warning">@Model.ProcessingOrders</div>
                            <small class="text-muted">Hazırlanan</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(102, 126, 234, 0.1);">
                            <div class="fs-4 fw-bold text-primary">@Model.ShippedOrders</div>
                            <small class="text-muted">Kargoda</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(16, 185, 129, 0.1);">
                            <div class="fs-4 fw-bold text-success">@Model.DeliveredOrders</div>
                            <small class="text-muted">Teslim Edilen</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(239, 68, 68, 0.1);">
                            <div class="fs-4 fw-bold text-danger">@Model.CancelledOrders</div>
                            <small class="text-muted">İptal Edilen</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(139, 92, 246, 0.1);">
                            <div class="fs-4 fw-bold" style="color: #8b5cf6;">@Model.RefundedOrders</div>
                            <small class="text-muted">İade Edilen</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="text-center p-3 rounded-3" style="background: rgba(102, 126, 234, 0.1);">
                            <div class="fs-4 fw-bold text-primary">@Model.TotalOrders</div>
                            <small class="text-muted">Toplam</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hızlı İstatistikler -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2 text-success"></i>Hızlı Bakış
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-info bg-opacity-15 p-2 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="fas fa-tags text-info"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="mb-0 fw-bold">@Model.TotalBrands</h5>
                        <small class="text-muted">Marka</small>
                    </div>
                    <a asp-controller="Brand" asp-action="Index" class="btn btn-sm btn-outline-info" style="border-radius: 8px;">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px; background: rgba(139, 92, 246, 0.15);">
                            <i class="fas fa-layer-group" style="color: #8b5cf6;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="mb-0 fw-bold">@Model.TotalCategories</h5>
                        <small class="text-muted">Kategori</small>
                    </div>
                    <a asp-controller="Category" asp-action="Index" class="btn btn-sm btn-outline-secondary" style="border-radius: 8px;">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-warning bg-opacity-15 p-2 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="fas fa-star text-warning"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="mb-0 fw-bold">
                            @Model.TotalReviews
                            <small class="fw-normal text-muted">(@Model.AverageRating.ToString("0.0") ★)</small>
                        </h5>
                        <small class="text-muted">
                            Yorum
                            @if (Model.PendingReviews > 0)
                            {
                                <span class="badge bg-warning text-dark ms-1">@Model.PendingReviews bekleyen</span>
                            }
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Üçüncü Satır - Son Siparişler & Düşük Stok -->
<div class="row g-4">
    <!-- Son Siparişler -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2 text-primary"></i>Son Siparişler
                </h5>
                <a asp-controller="Order" asp-action="Index" class="btn btn-sm btn-outline-primary" style="border-radius: 8px;">
                    Tümünü Gör
                </a>
            </div>
            <div class="card-body p-0">
                @if (Model.RecentOrders != null && Model.RecentOrders.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Sipariş No</th>
                                    <th>Müşteri</th>
                                    <th>Tutar</th>
                                    <th>Durum</th>
                                    <th>Tarih</th>
                                    <th class="text-end pe-4">İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in Model.RecentOrders)
                                {
                                    var initials = !string.IsNullOrEmpty(order.CustomerName)
                                    ? string.Join("", order.CustomerName.Split(' ').Take(2).Select(x => x.FirstOrDefault())).ToUpper()
                                    : "??";

                                    <tr>
                                        <td class="ps-4">
                                            <span class="fw-semibold text-primary">#@order.OrderNumber</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center"
                                                     style="width: 32px; height: 32px; min-width: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                    <span class="text-white fw-medium" style="font-size: 0.7rem;">@initials</span>
                                                </div>
                                                <span class="text-truncate" style="max-width: 120px;">@order.CustomerName</span>
                                            </div>
                                        </td>
                                        <td class="fw-semibold">
                                            @(order.CurrencyCode == "TRY" ? "₺" : order.CurrencyCode)@order.TotalAmount.ToString("N2")
                                        </td>
                                        <td>
                                            <span class="badge-status @OrderStatusHelper.GetStatusBadgeClass(order.Status)">
                                                <i class="fas @OrderStatusHelper.GetStatusIcon(order.Status) me-1"></i>
                                                @OrderStatusHelper.GetStatusDisplayText(order.Status)
                                            </span>
                                        </td>
                                        <td class="text-muted">
                                            @{
                                                var timeAgo = DateTime.Now - order.OrderDate;
                                                string timeText;
                                                if (timeAgo.TotalMinutes < 60)
                                                    timeText = $"{(int)timeAgo.TotalMinutes} dk önce";
                                                else if (timeAgo.TotalHours < 24)
                                                    timeText = $"{(int)timeAgo.TotalHours} saat önce";
                                                else
                                                    timeText = $"{(int)timeAgo.TotalDays} gün önce";
                                            }
                                            @timeText
                                        </td>
                                        <td class="text-end pe-4">
                                            <a asp-controller="Order" asp-action="Detail" asp-route-orderNumber="@order.OrderNumber"
                                               class="btn btn-sm btn-outline-primary" style="border-radius: 8px;">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3 opacity-50"></i>
                        <p class="text-muted mb-0">Henüz sipariş bulunmuyor.</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Düşük Stoklu Ürünler -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Düşük Stok
                </h5>
                <a asp-controller="Product" asp-action="Index" class="btn btn-sm btn-outline-warning" style="border-radius: 8px;">
                    Tümü
                </a>
            </div>
            <div class="card-body">
                @if (Model.LowStockProductsList != null && Model.LowStockProductsList.Any())
                {
                    @foreach (var product in Model.LowStockProductsList)
                    {
                        var imageUrl = !string.IsNullOrEmpty(product.ImageUrl)
                        ? (product.ImageUrl.StartsWith("http") ? product.ImageUrl : $"{apiBaseUrl}/{product.ImageUrl.TrimStart('/')}")
                        : "";
                        var isLast = product == Model.LowStockProductsList.Last();

                        <div class="d-flex align-items-center gap-3 @(!isLast ? "mb-3 pb-3 border-bottom" : "")">
                            <div class="flex-shrink-0">
                                @if (!string.IsNullOrEmpty(imageUrl))
                                {
                                    <img src="@imageUrl" alt="@product.Name"
                                         class="rounded" style="width: 45px; height: 45px; object-fit: cover;">
                                }
                                else
                                {
                                    <div class="rounded d-flex align-items-center justify-content-center bg-light"
                                         style="width: 45px; height: 45px;">
                                        <i class="fas fa-box text-muted"></i>
                                    </div>
                                }
                            </div>
                            <div class="flex-grow-1 min-width-0">
                                <h6 class="mb-0 text-truncate">@product.Name</h6>
                                <small class="text-muted">@product.Sku</small>
                            </div>
                            <div class="text-end">
                                @if (product.Stock == 0)
                                {
                                    <span class="badge bg-danger">Tükendi</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">@product.Stock adet</span>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-2x text-success mb-2 opacity-50"></i>
                        <p class="text-muted mb-0 small">Düşük stoklu ürün yok</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .badge-status {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

            .badge-status.pending {
                background: rgba(245, 158, 11, 0.15);
                color: #f59e0b;
            }

            .badge-status.info {
                background: rgba(59, 130, 246, 0.15);
                color: #3b82f6;
            }

            .badge-status.warning {
                background: rgba(245, 158, 11, 0.15);
                color: #f59e0b;
            }

            .badge-status.primary {
                background: rgba(102, 126, 234, 0.15);
                color: #667eea;
            }

            .badge-status.active {
                background: rgba(16, 185, 129, 0.15);
                color: #10b981;
            }

            .badge-status.inactive {
                background: rgba(239, 68, 68, 0.15);
                color: #ef4444;
            }

            .badge-status.refunded {
                background: rgba(139, 92, 246, 0.15);
                color: #8b5cf6;
            }

        .btn-primary-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 10px;
        }

            .btn-primary-gradient:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                color: white;
            }

        .stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-card .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .min-width-0 {
            min-width: 0;
        }

        .table > :not(caption) > * > * {
            padding: 0.875rem 0.75rem;
        }
    </style>
}