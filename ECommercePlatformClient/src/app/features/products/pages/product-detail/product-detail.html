<div class="product-detail-page">
  <!-- Loading -->
  @if (loading()) {
    <div class="loading-container">
      <app-loading-spinner message="Ürün yükleniyor..." minHeight="60vh" />
    </div>
  }

  <!-- Error -->
  @if (error(); as errorMessage) {
    <div class="container py-5">
      <div class="error-card">
        <div class="error-icon">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h3>Bir hata oluştu</h3>
        <p>{{ errorMessage }}</p>
        <div class="error-actions">
          <button type="button" class="btn btn-primary" (click)="loadProduct(product()?.id || '')">
            <i class="bi bi-arrow-clockwise"></i>
            Tekrar Dene
          </button>
          <a routerLink="/products" class="btn btn-glass">
            <i class="bi bi-arrow-left"></i>
            Ürünlere Dön
          </a>
        </div>
      </div>
    </div>
  }

  <!-- Product Content -->
  @if (product(); as p) {
    <!-- Breadcrumb -->
    <div class="breadcrumb-section">
      <div class="container">
        <nav class="breadcrumb-nav" aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a routerLink="/"><i class="bi bi-house"></i></a>
            </li>
            <li class="breadcrumb-item">
              <a routerLink="/products">Ürünler</a>
            </li>
            @if (p.categoryName) {
              <li class="breadcrumb-item">
                <a [routerLink]="['/products']" [queryParams]="{ category: p.categoryId }">
                  {{ p.categoryName }}
                </a>
              </li>
            }
            <li class="breadcrumb-item active" aria-current="page">{{ p.name }}</li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Main Product Section -->
    <section class="product-main-section">
      <div class="container">
        <div class="product-grid">
          <!-- Product Gallery -->
          <div class="product-gallery">
            <div class="gallery-main">
              <div class="main-image-wrapper">
                @if (selectedImage()) {
                  <img 
                    [src]="normalizeImageUrl(selectedImage()!.imageUrl) " 
                    [alt]="p.name"
                    class="main-image"
                  />
                } @else if (p.mainImageUrl) {
                  <img 
                    [src]="normalizeImageUrl(p.mainImageUrl) " 
                    [alt]="p.name"
                    class="main-image"
                  />
                } @else {
                  <div class="no-image">
                    <i class="bi bi-image"></i>
                    <span>Görsel Yok</span>
                  </div>
                }
                
                <!-- Image Actions -->
                <div class="image-actions">
                  <button type="button" class="image-action-btn" title="Tam Ekran">
                    <i class="bi bi-arrows-fullscreen"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Thumbnails -->
            @if (p.images.length > 1) {
              <div class="gallery-thumbnails">
                @for (image of p.images; track image.id) {
                  <button 
                    type="button"
                    class="thumbnail-btn"
                    [class.active]="selectedImage()?.id === image.id"
                    (click)="selectImage(image)"
                  >
                    <img [src]="normalizeImageUrl(image.imageUrl) " [alt]="p.name" />
                  </button>
                }
              </div>
            }
          </div>

          <!-- Product Info -->
          <div class="product-info">
            <!-- Badges -->
            <div class="product-badges">
              @if (p.categoryName) {
                <span class="badge badge-category">{{ p.categoryName }}</span>
              }
              <span class="badge badge-sku">SKU: {{ p.sku }}</span>
            </div>

            <!-- Title -->
            <h1 class="product-title">{{ p.name }}</h1>

            <!-- Rating (Placeholder) -->
            <div class="product-rating">
              <div class="rating-stars">
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-fill"></i>
                <i class="bi bi-star-half"></i>
              </div>
              <span class="rating-value">4.5</span>
              <span class="rating-count">(128 değerlendirme)</span>
            </div>

            <!-- Price -->
            <div class="product-price-section">
              <span class="price-current">{{ formattedPrice() }}</span>
              <!-- Eğer indirimli fiyat varsa -->
              <!-- <span class="price-old">₺1.299,00</span> -->
              <!-- <span class="price-discount">%20 İndirim</span> -->
            </div>

            <!-- Stock Status -->
            <div class="stock-status" [class]="stockStatus().class">
              <i class="bi" [class.bi-check-circle-fill]="!isOutOfStock()" [class.bi-x-circle-fill]="isOutOfStock()"></i>
              <span>{{ stockStatus().text }}</span>
            </div>

            <!-- Short Description -->
            @if (p.description) {
              <p class="product-short-desc">
                {{ p.description.length > 200 ? p.description.substring(0, 200) + '...' : p.description }}
              </p>
            }

            <!-- Quantity & Add to Cart -->
            @if (!isOutOfStock()) {
              <div class="purchase-section">
                <div class="quantity-selector">
                  <label class="quantity-label">Adet</label>
                  <div class="quantity-controls">
                    <button 
                      type="button" 
                      class="qty-btn"
                      [disabled]="quantity() <= 1"
                      (click)="decrementQuantity()"
                    >
                      <i class="bi bi-dash"></i>
                    </button>
                    <input 
                      type="number" 
                      class="qty-input"
                      [value]="quantity()"
                      (change)="updateQuantity($event)"
                      min="1"
                      [max]="p.stock"
                    />
                    <button 
                      type="button" 
                      class="qty-btn"
                      [disabled]="quantity() >= p.stock"
                      (click)="incrementQuantity()"
                    >
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>

                <div class="action-buttons">
                  <button 
                    type="button"
                    class="btn btn-accent btn-lg flex-grow-1"
                    (click)="addToCart()"
                  >
                    <i class="bi bi-bag-plus"></i>
                    <span>Sepete Ekle</span>
                  </button>
                  <button 
                    type="button"
                    class="btn btn-glass btn-lg btn-icon"
                    title="Favorilere Ekle"
                    (click)="addToWishlist()"
                  >
                    <i class="bi bi-heart"></i>
                  </button>
                </div>
              </div>
            } @else {
              <div class="out-of-stock-section">
                <div class="out-of-stock-message">
                  <i class="bi bi-bell"></i>
                  <div>
                    <strong>Ürün şu an stokta yok</strong>
                    <p>Stoka girince haberdar olmak için e-posta bırakın.</p>
                  </div>
                </div>
                <div class="notify-form">
                  <input type="email" placeholder="E-posta adresiniz" class="notify-input" />
                  <button type="button" class="btn btn-primary">Bildir</button>
                </div>
              </div>
            }

            <!-- Product Features -->
            <div class="product-features">
              <div class="feature-item">
                <div class="feature-icon">
                  <i class="bi bi-truck"></i>
                </div>
                <div class="feature-text">
                  <strong>Ücretsiz Kargo</strong>
                  <span>150 TL üzeri siparişlerde</span>
                </div>
              </div>
              <div class="feature-item">
                <div class="feature-icon">
                  <i class="bi bi-arrow-repeat"></i>
                </div>
                <div class="feature-text">
                  <strong>Kolay İade</strong>
                  <span>14 gün içinde ücretsiz</span>
                </div>
              </div>
              <div class="feature-item">
                <div class="feature-icon">
                  <i class="bi bi-shield-check"></i>
                </div>
                <div class="feature-text">
                  <strong>Güvenli Ödeme</strong>
                  <span>256-bit SSL şifreleme</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Product Tabs Section -->
    <section class="product-tabs-section">
      <div class="container">
        <div class="tabs-wrapper">
          <!-- Tab Headers -->
          <div class="tabs-header">
            <button 
              type="button"
              class="tab-btn"
              [class.active]="activeTab() === 'description'"
              (click)="setActiveTab('description')"
            >
              <i class="bi bi-file-text"></i>
              <span>Açıklama</span>
            </button>
            <button 
              type="button"
              class="tab-btn"
              [class.active]="activeTab() === 'details'"
              (click)="setActiveTab('details')"
            >
              <i class="bi bi-list-check"></i>
              <span>Özellikler</span>
            </button>
            <button 
              type="button"
              class="tab-btn"
              [class.active]="activeTab() === 'reviews'"
              (click)="setActiveTab('reviews')"
            >
              <i class="bi bi-chat-square-text"></i>
              <span>Yorumlar</span>
              <span class="tab-badge">128</span>
            </button>
          </div>

          <!-- Tab Content -->
          <div class="tabs-content">
            @if (activeTab() === 'description') {
              <div class="tab-pane">
                <div class="description-content">
                  @if (p.description) {
                    <p>{{ p.description }}</p>
                  } @else {
                    <div class="empty-content">
                      <i class="bi bi-file-text"></i>
                      <p>Bu ürün için açıklama bulunmamaktadır.</p>
                    </div>
                  }
                </div>
              </div>
            }

            @if (activeTab() === 'details') {
              <div class="tab-pane">
                <div class="details-table">
                  <div class="detail-row">
                    <span class="detail-label">Ürün Kodu (SKU)</span>
                    <span class="detail-value">{{ p.sku }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Kategori</span>
                    <span class="detail-value">{{ p.categoryName || '-' }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Stok Durumu</span>
                    <span class="detail-value" [class]="stockStatus().class">
                      {{ stockStatus().text }}
                    </span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Stok Adedi</span>
                    <span class="detail-value">{{ p.stock }}</span>
                  </div>
                </div>
              </div>
            }

            @if (activeTab() === 'reviews') {
              <div class="tab-pane">
                <div class="reviews-empty">
                  <div class="empty-icon">
                    <i class="bi bi-chat-square-text"></i>
                  </div>
                  <h4>Henüz yorum yapılmamış</h4>
                  <p>Bu ürün hakkında ilk yorumu siz yapın!</p>
                  <button type="button" class="btn btn-primary">
                    <i class="bi bi-pencil"></i>
                    Yorum Yaz
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Related Products (Placeholder) -->
    <section class="related-section section-padding">
      <div class="container">
        <div class="section-header">
          <div class="section-header-left">
            <span class="section-badge">
              <i class="bi bi-grid"></i>
              Benzer Ürünler
            </span>
            <h2 class="section-title">Bunları da Beğenebilirsiniz</h2>
          </div>
          <a routerLink="/products" class="section-link">
            Tümünü Gör <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        
        <div class="related-placeholder">
          <p>İlgili ürünler yakında burada görünecek.</p>
        </div>
      </div>
    </section>
  }
</div>