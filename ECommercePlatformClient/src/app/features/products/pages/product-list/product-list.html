<div class="products-page">
  <section class="page-header">
    <div class="container">
      <nav class="breadcrumb-nav" aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a routerLink="/"><i class="bi bi-house"></i></a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Ürünler</li>
        </ol>
      </nav>
      
      <div class="page-header-content">
        <div class="page-header-text">
          <h1 class="page-title">
            {{ currentCategoryName() }}
          </h1>
          @if (pagination().totalCount > 0) {
            <p class="page-subtitle">{{ pagination().totalCount }} ürün bulundu</p>
          }
        </div>
      </div>
    </div>
  </section>

  <div class="container">
    <div class="products-layout">
      <aside class="filters-sidebar">
        <div class="sidebar-card">
          <div class="sidebar-header">
            <h3 class="sidebar-title">
              <i class="bi bi-funnel"></i>
              Filtreler
            </h3>
            @if (searchQuery() || selectedCategory() || sortBy()) {
              <button type="button" class="clear-btn" (click)="clearFilters()">
                Temizle
              </button>
            }
          </div>

          <div class="filter-section">
            <label class="filter-label">Arama</label>
            <div class="search-input-wrapper">
              <i class="bi bi-search"></i>
              <input 
                type="text" 
                class="search-input"
                placeholder="Ürün ara..."
                [value]="searchQuery()"
                (input)="onSearchChange($any($event.target).value)"
              />
              @if (searchQuery()) {
                <button type="button" class="clear-input" (click)="clearSearch()">
                  <i class="bi bi-x"></i>
                </button>
              }
            </div>
          </div>

          <div class="filter-section">
            <label class="filter-label">Kategoriler</label>
            <div class="filter-options">
              <label class="filter-option">
                <input 
                  type="radio" 
                  name="category" 
                  [checked]="!selectedCategory()"
                  (change)="onCategoryChange('')"
                />
                <span class="option-label">Tümü</span>
                <span class="option-check"><i class="bi bi-check2"></i></span>
              </label>
              @for (category of categories(); track category.id) {
                <label class="filter-option">
                  <input 
                    type="radio" 
                    name="category" 
                    [checked]="selectedCategory() === category.id"
                    (change)="onCategoryChange(category.id)"
                  />
                  <span class="option-label">{{ category.name }}</span>
                  <span class="option-check"><i class="bi bi-check2"></i></span>
                </label>
              }
            </div>
          </div>
        </div>
      </aside>

      <main class="products-main">
        <div class="products-toolbar">
          <div class="toolbar-left">
            <button type="button" class="filter-toggle d-lg-none">
              <i class="bi bi-funnel"></i>
              Filtreler
            </button>

            <div class="sort-wrapper">
              <select 
                class="sort-select"
                [value]="sortBy()"
                (change)="onSortChange($any($event.target).value)"
              >
                <option value="">Varsayılan Sıralama</option>
                <option value="name-asc">İsim (A-Z)</option>
                <option value="name-desc">İsim (Z-A)</option>
                <option value="priceAmount-asc">Fiyat (Düşük-Yüksek)</option>
                <option value="priceAmount-desc">Fiyat (Yüksek-Düşük)</option>
                <option value="createdAt-desc">En Yeni</option>
              </select>
            </div>
          </div>

          <div class="toolbar-right">
            <div class="page-size-wrapper d-none d-md-block">
              <select 
                class="page-size-select"
                [value]="pageSize()"
                (change)="onPageSizeChange($any($event.target).value)"
              >
                <option [value]="12">12</option>
                <option [value]="24">24</option>
                <option [value]="48">48</option>
              </select>
            </div>

            <div class="view-toggle">
              <button 
                type="button"
                class="view-btn"
                [class.active]="viewMode() === 'grid'"
                (click)="viewMode.set('grid')"
                title="Izgara"
              >
                <i class="bi bi-grid-3x3-gap"></i>
              </button>
              <button 
                type="button"
                class="view-btn"
                [class.active]="viewMode() === 'list'"
                (click)="viewMode.set('list')"
                title="Liste"
              >
                <i class="bi bi-list-ul"></i>
              </button>
            </div>
          </div>
        </div>

        @if (searchQuery() || selectedCategory()) {
          <div class="active-filters">
            @if (searchQuery()) {
              <span class="filter-tag">
                "{{ searchQuery() }}"
                <button type="button" (click)="clearSearch()"><i class="bi bi-x"></i></button>
              </span>
            }
            @if (selectedCategory()) {
              <span class="filter-tag">
                {{ currentCategoryName() }}
                <button type="button" (click)="onCategoryChange('')"><i class="bi bi-x"></i></button>
              </span>
            }
          </div>
        }

        @if (loading()) {
          <app-loading-spinner message="Ürünler yükleniyor..." minHeight="400px" />
        }

        @if (error(); as errorMessage) {
          <div class="error-state">
            <div class="error-icon"><i class="bi bi-exclamation-triangle"></i></div>
            <h4>Bir hata oluştu</h4>
            <p>{{ errorMessage }}</p>
            <button type="button" class="btn btn-primary" (click)="loadProducts()">
              <i class="bi bi-arrow-clockwise"></i> Tekrar Dene
            </button>
          </div>
        }

        @if (isEmpty() && !loading()) {
          <div class="empty-state">
            <div class="empty-icon"><i class="bi bi-inbox"></i></div>
            <h4>Ürün Bulunamadı</h4>
            <p>
              @if (searchQuery()) { "{{ searchQuery() }}" için sonuç bulunamadı. } 
              @else if (selectedCategory()) { Bu kategoride henüz ürün bulunmuyor. } 
              @else { Henüz ürün eklenmemiş. }
            </p>
            <button type="button" class="btn btn-primary" (click)="clearFilters()">
              <i class="bi bi-arrow-counterclockwise"></i> Filtreleri Temizle
            </button>
          </div>
        }

        @if (hasProducts() && !loading()) {
          <div class="products-grid" [class.list-view]="viewMode() === 'list'">
            @for (product of products(); track product.id; let i = $index) {
              
              @defer (on viewport; prefetch on idle) {
                <div class="product-item animate-fade-in-up" [style.animation-delay.ms]="i * 50">
                  <app-product-card 
                    [product]="product"
                    (addToCart)="onAddToCart($event)"
                  />
                </div>
              } @placeholder {
                <div class="product-item">
                  <div class="card-skeleton" [style.height]="viewMode() === 'grid' ? '400px' : '180px'" 
                       style="background: #f0f0f0; border-radius: 12px; animation: pulse 1.5s infinite;">
                  </div>
                </div>
              } @loading (after 100ms; minimum 500ms) {
                <div class="product-item">
                  <div class="card-skeleton shimmer" [style.height]="viewMode() === 'grid' ? '400px' : '180px'"></div>
                </div>
              }
            }
          </div>

          @defer (on idle) {
            <app-pagination 
              [pagination]="pagination()"
              (pageChange)="onPageChange($event)"
            />
          }
        }
      </main>
    </div>
  </div>
</div>